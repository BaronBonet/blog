---
title: "Hexagonal Architecture and Chat GPT - Part Two"
date: 2023-04-10T09:36:34+02:00
draft: false
---

In this post, I'll guide you through my interactions with ChatGPT-4, as it helps write and test the entire New York Times implementation of the news adapter we created in Part 1. As a disclaimer, I don't recommend using this approach if you're working on sensitive projects or those involving intellectual property. Additionally, never blindly copy, paste, and execute any code generated by AI tools.

I'll enclose everything I copied and pasted to ChatGPT in code blocks. Try asking ChatGPT yourself, I'm curious if the responses are different.

## New York Times News Adapter 

Instead of figuring out whether an API exists or if you need to scrape content, let ChatGPT handle that for you.

### Initial prompt

```go
I am creating an application in golang following the principals of hexagonal architecture. I would like for you to create an NewYorkTime news adapter that fits the following interface.


package ports

import (
	"context"
	"github.com/BaronBonet/content-generator/internal/core/domain"
)
// NewsAdapter interacts with external news services
type NewsAdapter interface {
	// GetMainArticle finds the main article, the concept of the main article will be adapter specific.
	GetMainArticle(ctx context.Context) (domain.NewsArticle, error)
}

package domain

import "time"

type NewsArticle struct {
	Title string
	Body  string
	Date  Date
}

type Date struct {
	Day   int
	Month time.Month
	Year  int
}

This adapter will implement `GetMainArticle`.
```

ChatGPT responded with what appeared to be functional code, along with instructions on obtaining a NYTimes API key. I created an internal/adapters directory and placed the provided code there.

![chatGPT newsAdapter Response](https://cdn.ericcbonet.com/chatgpt-newsAdapter-response.png)

### Does it work?

I wanted to test this with my debugger and know if it actually works, so I asked chatGPT to wire it up. 

```
thanks, can you now wire this adapter up for me in a main.go file, so I can test this in my goland debugger
```

![debugger prompt](https://cdn.ericcbonet.com/debugger-prompt.png)

After changing a few imports in the adapter and `cmd/debugger/main.go` code, I tested the code in my goland debugger, and it worked! 

![chatGPT new york times test](https://cdn.ericcbonet.com/debugging-chatgpt-code.png)

### Prompt ChatGPT to write the tests

We're on a roll, lets finish this off by asking ChatGPT to make a test for this. I've noticed it's better if you send as much information as possible, that's why I copy/pasted all the adapter code, that ChatGPT wrote (although I did make a few changes).


```go
It works great! Could you now write some test for this adapter, you should only have to mock this line.

resp, err := http.DefaultClient.Do(req)

package adapters

import (
	"context"
	"encoding/json"
	"errors"
	"fmt"
	"io/ioutil"
	"net/http"
	"time"

	"github.com/BaronBonet/content-generator/internal/core/domain"
	"github.com/BaronBonet/content-generator/internal/core/ports"
)

const (
	apiURL = "https://api.nytimes.com/svc/topstories/v2/home.json?api-key=%s"
)

type nyTimesAdapter struct {
	apiKey string
}

func NewNYTimesNewsAdapter(apiKey string) ports.NewsAdapter {
	return &nyTimesAdapter{apiKey: apiKey}
}

func (n *nyTimesAdapter) GetMainArticle(ctx context.Context) (domain.NewsArticle, error) {
	url := fmt.Sprintf(apiURL, n.apiKey)
	req, err := http.NewRequestWithContext(ctx, http.MethodGet, url, nil)
	if err != nil {
		return domain.NewsArticle{}, err
	}

	resp, err := http.DefaultClient.Do(req)
	if err != nil {
		return domain.NewsArticle{}, err
	}
	defer resp.Body.Close()

	if resp.StatusCode != http.StatusOK {
		return domain.NewsArticle{}, errors.New("failed to fetch data from New York Times API")
	}

	body, err := ioutil.ReadAll(resp.Body)
	if err != nil {
		return domain.NewsArticle{}, err
	}

	var apiResponse NYTApiResponse
	err = json.Unmarshal(body, &apiResponse)
	if err != nil {
		return domain.NewsArticle{}, err
	}

	if len(apiResponse.Results) == 0 {
		return domain.NewsArticle{}, errors.New("no articles found")
	}

	mainArticle := apiResponse.Results[0]
	date, err := time.Parse(time.RFC3339, mainArticle.PublishedDate)
	if err != nil {
		return domain.NewsArticle{}, err
	}

	return domain.NewsArticle{
		Title: mainArticle.Title,
		Body:  mainArticle.Abstract,
		Date: domain.Date{
			Day:   date.Day(),
			Month: date.Month(),
			Year:  date.Year(),
		},
	}, nil
}

type NYTApiResponse struct {
	Results []NYTArticle `json:"results"`
}

type NYTArticle struct {
	Title         string `json:"title"`
	Abstract      string `json:"abstract"`
	PublishedDate string `json:"published_date"`
}
```



### ChatGPT's Tests

I've included the start and end of the response ChatGPT made [the entire test is here](https://github.com/BaronBonet/content-generator/blob/main/internal/adapters/newsadapter_nytimes_test.go). I like how it decided to slightly change the implementation of the adapter to make it more testable this required a couple of minutes of work on my end to switch things around but worth it to have a few tests for this adapter. 

![ChatGPT Test Response](https://cdn.ericcbonet.com/chatgpt-writes-test.png)
...
![ChatGPT Test Response Part 2](https://cdn.ericcbonet.com/chatgpt-writes-test-part-2.png)

### Current State of the Project

I think I spent 10-15 minutes actually creating this adapter. The most time-consuming parts were registering up for the New York Times API (which was easy and took only a couple of minutes) and waiting for ChatGPT to respond.

```
.
├── cmd
│   └── debugger
│       └── main.go
├── go.mod
└── internal
    ├── adapters
    │   ├── newsadapter_nytimes.go
    │   └── newsadapter_nytimes_test.go
    └── core
        ├── domain
        │   └── domain.go
        ├── ports
        │   └── driven.go
        │   └── infrastructure.go
        │   └── service.go
        └── service
            └── service.go
```